<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Remove Functionality</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .btn { padding: 10px 20px; margin: 10px; cursor: pointer; }
        .btn-test { background: #3498db; color: white; border: none; }
        .btn-remove { background: #e74c3c; color: white; border: none; }
        .property-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>Remove Functionality Test</h1>

    <div class="test-section">
        <h2>Test 1: Authentication Check</h2>
        <button class="btn btn-test" onclick="testAuth()">Check Authentication</button>
        <div id="auth-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: API Endpoint Test</h2>
        <button class="btn btn-test" onclick="testAPIEndpoint()">Test DELETE Endpoint</button>
        <div id="api-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Sample Property Remove</h2>
        <div class="property-card" data-property-id="123">
            <div class="property-address">Test Property Address</div>
            <div class="property-price">$250,000</div>
            <button class="btn btn-remove" onclick="testRemoveProperty(123, true)">Remove Test Property</button>
        </div>
        <div id="remove-result" class="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';

        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const style = isError ? 'color: red;' : 'color: green;';
            element.innerHTML += `<div style="${style}">[${timestamp}] ${message}</div>`;
        }

        function testAuth() {
            const authToken = sessionStorage.getItem('authToken') || localStorage.getItem('authToken');
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');

            log('auth-result', `Auth Token: ${authToken ? 'Found' : 'Missing'}`);
            log('auth-result', `Current User: ${currentUser ? JSON.stringify(currentUser) : 'Missing'}`);

            if (!authToken) {
                log('auth-result', 'Setting test auth token...', false);
                sessionStorage.setItem('authToken', 'test-token');
                sessionStorage.setItem('currentUser', JSON.stringify({
                    userID: 1,
                    name: 'Test User',
                    email: 'test@example.com'
                }));
                log('auth-result', 'Test credentials set', false);
            }
        }

        async function testAPIEndpoint() {
            const testPropertyId = 999; // Non-existent ID for testing

            try {
                log('api-result', `Testing DELETE ${API_BASE}/saved-properties/${testPropertyId}`);

                const response = await fetch(`${API_BASE}/saved-properties/${testPropertyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('authToken')}`
                    }
                });

                log('api-result', `Response Status: ${response.status}`);
                log('api-result', `Response OK: ${response.ok}`);

                if (response.ok) {
                    const result = await response.json();
                    log('api-result', `Response Data: ${JSON.stringify(result)}`);
                } else {
                    const errorText = await response.text();
                    log('api-result', `Error Response: ${errorText}`, true);
                }

            } catch (error) {
                log('api-result', `Network Error: ${error.message}`, true);
                log('api-result', `This might indicate the server is not running`, true);
            }
        }

        async function testRemoveProperty(propertyId, isFromDatabase = false) {
            try {
                log('remove-result', `Starting removal test for property ID: ${propertyId}`);
                log('remove-result', `Database property: ${isFromDatabase}`);

                const authToken = sessionStorage.getItem('authToken');
                if (!authToken) {
                    log('remove-result', 'No auth token found! Running auth test first...', true);
                    testAuth();
                    return;
                }

                const response = await fetch(`${API_BASE}/saved-properties/${propertyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                log('remove-result', `DELETE request sent to: ${API_BASE}/saved-properties/${propertyId}`);
                log('remove-result', `Response status: ${response.status}`);
                log('remove-result', `Response headers: ${JSON.stringify([...response.headers])}`);

                if (response.ok) {
                    const result = await response.json();
                    log('remove-result', `Success! Response: ${JSON.stringify(result)}`);

                    if (result.success) {
                        log('remove-result', '✅ Property removed successfully from database!');
                    } else {
                        log('remove-result', `❌ Server reported failure: ${result.message}`, true);
                    }
                } else {
                    const errorText = await response.text();
                    log('remove-result', `❌ HTTP Error ${response.status}: ${errorText}`, true);

                    // Common error analysis
                    if (response.status === 401) {
                        log('remove-result', 'This is an authentication error - check your login status', true);
                    } else if (response.status === 404) {
                        log('remove-result', 'Property not found or endpoint doesn\'t exist', true);
                    } else if (response.status === 500) {
                        log('remove-result', 'Server internal error - check backend logs', true);
                    }
                }

            } catch (error) {
                log('remove-result', `❌ Network/JavaScript Error: ${error.message}`, true);
                log('remove-result', 'This usually means the server is not running or there\'s a CORS issue', true);
            }
        }

        // Auto-run auth test on page load
        window.onload = function() {
            testAuth();
            log('auth-result', 'Page loaded - ready for testing!', false);
        };
    </script>
</body>
</html>
