<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Save Functionality</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .btn {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .property-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: white;
        }
        .property-image img {
            width: 100%;
            max-width: 300px;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
        }
        .save-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        #console-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Test Save Functionality</h1>

    <div class="test-section">
        <h2>Step 1: Test Server Connection</h2>
        <button class="btn" onclick="testServerConnection()">Test Server Connection</button>
        <button class="btn" onclick="testDatabaseApartments()">Check Database Apartments</button>
        <button class="btn" onclick="addTestApartments()">Add Test Apartments</button>
    </div>

    <div class="test-section">
        <h2>Step 2: Test Property Save</h2>
        <div class="property-card">
            <div class="property-image">
                <img src="https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400" alt="Test Property" />
            </div>
            <h3>Test Property #1</h3>
            <p>Property ID: 1</p>
            <p>Location: Test Location</p>
            <button class="save-btn" onclick="testSaveProperty(1, 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400')">
                Save Property #1
            </button>
        </div>

        <div class="property-card">
            <div class="property-image">
                <img src="https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=400" alt="Test Property" />
            </div>
            <h3>Test Property #2</h3>
            <p>Property ID: 2</p>
            <p>Location: Test Location 2</p>
            <button class="save-btn" onclick="testSaveProperty(2, 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=400')">
                Save Property #2
            </button>
        </div>
    </div>

    <div class="test-section">
        <h2>Console Output</h2>
        <div id="console-output">Console output will appear here...\n</div>
        <button class="btn" onclick="clearConsole()">Clear Console</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';

        // Custom console log function to display in our output div
        function logToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            const output = document.getElementById('console-output');
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;

            // Also log to browser console
            console.log(message);
        }

        function clearConsole() {
            document.getElementById('console-output').textContent = 'Console cleared...\n';
        }

        async function testServerConnection() {
            logToConsole('Testing server connection...');

            try {
                const response = await fetch(`${API_BASE}/apartments`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    logToConsole(`✅ Server is running! Found ${data.length} apartments in database.`, 'success');
                    logToConsole(`Response: ${JSON.stringify(data, null, 2)}`);
                } else {
                    logToConsole(`❌ Server responded with error: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                logToConsole(`❌ Server connection failed: ${error.message}`, 'error');
                logToConsole('Make sure the Spring Boot server is running on port 8080');
            }
        }

        async function testDatabaseApartments() {
            logToConsole('Checking database apartments...');

            try {
                const response = await fetch(`${API_BASE}/apartments`);
                if (response.ok) {
                    const apartments = await response.json();
                    logToConsole(`Found ${apartments.length} apartments in database:`);
                    apartments.forEach(apt => {
                        logToConsole(`- ID: ${apt.apartmentID}, Type: ${apt.type}, Location: ${apt.location}, Description: ${apt.description || 'No description'}`);
                    });
                } else {
                    logToConsole(`Failed to fetch apartments: ${response.status}`, 'error');
                }
            } catch (error) {
                logToConsole(`Error fetching apartments: ${error.message}`, 'error');
            }
        }

        async function addTestApartments() {
            logToConsole('Adding test apartments to database...');

            const testApartments = [
                {
                    type: "Apartment",
                    price: "275000",
                    bedrooms: "1",
                    location: "Downtown Lofts, New York",
                    description: "Modern 1-bedroom apartment"
                },
                {
                    type: "Condo",
                    price: "450000",
                    bedrooms: "2",
                    location: "Lakeside Condos, Chicago",
                    description: "Spacious 2-bedroom condo"
                }
            ];

            for (let i = 0; i < testApartments.length; i++) {
                try {
                    const response = await fetch(`${API_BASE}/apartments/add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(testApartments[i])
                    });

                    if (response.ok) {
                        const result = await response.json();
                        logToConsole(`✅ Added apartment ${i + 1} with ID: ${result.apartmentID}`, 'success');
                    } else {
                        const error = await response.text();
                        logToConsole(`❌ Failed to add apartment ${i + 1}: ${error}`, 'error');
                    }
                } catch (error) {
                    logToConsole(`❌ Error adding apartment ${i + 1}: ${error.message}`, 'error');
                }
            }
        }

        async function testSaveProperty(propertyId, imageUrl) {
            logToConsole(`Testing save property ${propertyId} with image URL: ${imageUrl}`);

            try {
                const response = await fetch(`${API_BASE}/apartments/${propertyId}/description`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageUrl: imageUrl
                    })
                });

                logToConsole(`Response status: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    logToConsole(`✅ Successfully saved image URL to apartment ${propertyId}!`, 'success');
                    logToConsole(`Response: ${JSON.stringify(result, null, 2)}`);

                    // Verify the save by fetching the apartment
                    await verifyApartmentUpdate(propertyId);
                } else {
                    const errorText = await response.text();
                    logToConsole(`❌ Failed to save: HTTP ${response.status}`, 'error');
                    logToConsole(`Error response: ${errorText}`);
                }
            } catch (error) {
                logToConsole(`❌ Error during save: ${error.message}`, 'error');
            }
        }

        async function verifyApartmentUpdate(apartmentId) {
            logToConsole(`Verifying apartment ${apartmentId} was updated...`);

            try {
                const response = await fetch(`${API_BASE}/apartments`);
                if (response.ok) {
                    const apartments = await response.json();
                    const apartment = apartments.find(apt => apt.apartmentID == apartmentId);

                    if (apartment) {
                        logToConsole(`✅ Verification: Apartment ${apartmentId} description is now: "${apartment.description}"`, 'success');
                    } else {
                        logToConsole(`❌ Verification failed: Apartment ${apartmentId} not found`, 'error');
                    }
                } else {
                    logToConsole(`❌ Verification failed: Could not fetch apartments`, 'error');
                }
            } catch (error) {
                logToConsole(`❌ Verification error: ${error.message}`, 'error');
            }
        }

        // Initialize
        logToConsole('Test page loaded. Ready to test save functionality.');
        logToConsole('Steps:');
        logToConsole('1. Click "Test Server Connection" to check if server is running');
        logToConsole('2. Click "Add Test Apartments" to add test data');
        logToConsole('3. Click "Save Property" buttons to test the save functionality');
    </script>
</body>
</html>
