<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Data Diagnostic Tool</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .log { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; font-family: monospace; font-size: 14px; max-height: 300px; overflow-y: auto; }
        .success { border-left-color: #28a745; color: #155724; }
        .error { border-left-color: #dc3545; color: #721c24; }
        .warning { border-left-color: #ffc107; color: #856404; }
        .data-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .data-table th { background-color: #f2f2f2; }
        .raw-data { font-family: monospace; font-size: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Database Data Diagnostic Tool</h1>
        <p>This tool will help identify why your existing database data isn't showing up in the dashboard.</p>

        <div class="section">
            <h2>Step 1: Check Server Connection</h2>
            <button class="btn btn-primary" onclick="checkServerConnection()">Test Server Connection</button>
            <div id="server-log" class="log"></div>
        </div>

        <div class="section">
            <h2>Step 2: Test Database API Endpoints</h2>
            <button class="btn btn-primary" onclick="testDatabaseEndpoints()">Test All Database Endpoints</button>
            <div id="endpoint-log" class="log"></div>
        </div>

        <div class="section">
            <h2>Step 3: Fetch Raw Database Data</h2>
            <button class="btn btn-success" onclick="fetchRawDatabaseData()">Fetch All Saved Properties</button>
            <div id="database-log" class="log"></div>
            <div id="database-results"></div>
        </div>

        <div class="section">
            <h2>Step 4: Test User ID Detection</h2>
            <button class="btn btn-primary" onclick="testUserIdDetection()">Check User ID Logic</button>
            <div id="userid-log" class="log"></div>
        </div>

        <div class="section">
            <h2>Step 5: Simulate Dashboard Load</h2>
            <button class="btn btn-success" onclick="simulateDashboardLoad()">Simulate Dashboard Loading Process</button>
            <div id="simulation-log" class="log"></div>
        </div>

        <div class="section">
            <h2>Diagnostic Summary</h2>
            <div id="summary-log" class="log">
                <strong>Ready to diagnose...</strong>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let diagnosticResults = {
            serverConnection: false,
            endpointAccess: false,
            dataRetrieval: false,
            userIdDetection: false,
            dashboardSimulation: false
        };

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            let className = '';
            if (type === 'success') className = 'success';
            else if (type === 'error') className = 'error';
            else if (type === 'warning') className = 'warning';

            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function updateSummary() {
            const summary = document.getElementById('summary-log');
            const passed = Object.values(diagnosticResults).filter(r => r).length;
            const total = Object.keys(diagnosticResults).length;

            let status = '';
            if (passed === total) {
                status = '‚úÖ All diagnostics passed - Database should be working correctly';
            } else if (passed > 0) {
                status = `‚ö†Ô∏è ${passed}/${total} diagnostics passed - Issues found`;
            } else {
                status = '‚ùå No diagnostics completed yet';
            }

            const resultsList = Object.entries(diagnosticResults)
                .map(([key, value]) => `${key}: ${value ? '‚úÖ' : '‚ùå'}`)
                .join('<br>');

            summary.innerHTML = `<strong>Diagnostic Status:</strong> ${status}<br><br><strong>Results:</strong><br>${resultsList}`;
        }

        async function checkServerConnection() {
            log('server-log', 'Testing server connection...', 'info');

            try {
                // Test basic server connectivity
                const response = await fetch(`${API_BASE}/apartments`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                log('server-log', `Server response: ${response.status} ${response.statusText}`, 'info');

                if (response.ok || response.status === 404) {
                    log('server-log', '‚úÖ Server is running and accessible', 'success');
                    diagnosticResults.serverConnection = true;
                } else {
                    log('server-log', `‚ùå Server returned error: ${response.status}`, 'error');
                }

            } catch (error) {
                log('server-log', `‚ùå Server connection failed: ${error.message}`, 'error');
                log('server-log', 'Make sure Spring Boot application is running on localhost:8080', 'error');
            }

            updateSummary();
        }

        async function testDatabaseEndpoints() {
            log('endpoint-log', 'Testing database endpoints...', 'info');

            const endpoints = [
                { path: '/saved-properties/user/1', method: 'GET', description: 'Get saved properties for user 1' },
                { path: '/saved-properties/user/2', method: 'GET', description: 'Get saved properties for user 2' },
            ];

            let successCount = 0;

            for (const endpoint of endpoints) {
                try {
                    log('endpoint-log', `Testing: ${endpoint.method} ${endpoint.path}`, 'info');

                    const response = await fetch(`${API_BASE}${endpoint.path}`, {
                        method: endpoint.method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer test-token'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        log('endpoint-log', `‚úÖ ${endpoint.description}: SUCCESS (${Array.isArray(data) ? data.length : 'Unknown'} items)`, 'success');
                        successCount++;
                    } else if (response.status === 404) {
                        log('endpoint-log', `‚ö†Ô∏è ${endpoint.description}: No data found (404)`, 'warning');
                        successCount++;
                    } else {
                        const errorText = await response.text();
                        log('endpoint-log', `‚ùå ${endpoint.description}: ${response.status} - ${errorText}`, 'error');
                    }

                } catch (error) {
                    log('endpoint-log', `‚ùå ${endpoint.description}: ${error.message}`, 'error');
                }
            }

            if (successCount > 0) {
                diagnosticResults.endpointAccess = true;
            }

            updateSummary();
        }

        async function fetchRawDatabaseData() {
            log('database-log', 'Fetching raw database data...', 'info');

            const userIds = [1, 2]; // Test multiple user IDs
            let totalProperties = 0;

            const resultsContainer = document.getElementById('database-results');
            resultsContainer.innerHTML = '';

            for (const userId of userIds) {
                try {
                    log('database-log', `Fetching data for user ID: ${userId}`, 'info');

                    const response = await fetch(`${API_BASE}/saved-properties/user/${userId}`, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer test-token'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        log('database-log', `‚úÖ User ${userId}: Found ${data.length} properties`, 'success');
                        totalProperties += data.length;

                        if (data.length > 0) {
                            // Create table to display data
                            const table = document.createElement('table');
                            table.className = 'data-table';
                            table.innerHTML = `
                                <thead>
                                    <tr>
                                        <th>User ${userId} - Saved Properties (${data.length})</th>
                                        <th>SavedPropertyID</th>
                                        <th>Address</th>
                                        <th>Price</th>
                                        <th>Features</th>
                                        <th>Property Data (JSON)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map(item => `
                                        <tr>
                                            <td>${item.savedPropertyID}</td>
                                            <td>${item.userID}</td>
                                            <td>${item.propertyAddress || 'N/A'}</td>
                                            <td>${item.propertyPrice || 'N/A'}</td>
                                            <td>${item.propertyFeatures || 'N/A'}</td>
                                            <td class="raw-data" title="${item.propertyData || 'N/A'}">${item.propertyData || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            `;
                            resultsContainer.appendChild(table);
                        }

                    } else if (response.status === 404) {
                        log('database-log', `‚ö†Ô∏è User ${userId}: No properties found`, 'warning');
                    } else {
                        const errorText = await response.text();
                        log('database-log', `‚ùå User ${userId}: Error ${response.status} - ${errorText}`, 'error');
                    }

                } catch (error) {
                    log('database-log', `‚ùå User ${userId}: ${error.message}`, 'error');
                }
            }

            if (totalProperties > 0) {
                log('database-log', `‚úÖ Total properties found in database: ${totalProperties}`, 'success');
                diagnosticResults.dataRetrieval = true;
            } else {
                log('database-log', '‚ùå No properties found in database for any user', 'error');
            }

            updateSummary();
        }

        async function testUserIdDetection() {
            log('userid-log', 'Testing user ID detection logic...', 'info');

            // Test different scenarios
            const scenarios = [
                {
                    name: 'No user data',
                    sessionUser: null,
                    localUser: null,
                    expected: 1
                },
                {
                    name: 'Session user with userID',
                    sessionUser: { userID: 5, name: 'Session User' },
                    localUser: null,
                    expected: 5
                },
                {
                    name: 'Session user with id (fallback)',
                    sessionUser: { id: 3, name: 'Session User' },
                    localUser: null,
                    expected: 3
                },
                {
                    name: 'Local user fallback',
                    sessionUser: null,
                    localUser: { id: 2, name: 'Local User' },
                    expected: 2
                }
            ];

            let passedTests = 0;

            for (const scenario of scenarios) {
                // Simulate the user ID detection logic from dashboard
                let sessionUser = scenario.sessionUser;
                if (!sessionUser) {
                    sessionUser = scenario.localUser;
                }
                const userId = sessionUser ? sessionUser.userID || sessionUser.id : 1;

                if (userId === scenario.expected) {
                    log('userid-log', `‚úÖ ${scenario.name}: Detected user ID ${userId} (expected ${scenario.expected})`, 'success');
                    passedTests++;
                } else {
                    log('userid-log', `‚ùå ${scenario.name}: Detected user ID ${userId} (expected ${scenario.expected})`, 'error');
                }
            }

            // Check current browser state
            const currentSessionUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
            const currentLocalUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const currentUserId = currentSessionUser ? currentSessionUser.userID || currentSessionUser.id : (currentLocalUser ? currentLocalUser.id : 1);

            log('userid-log', `Current browser state:`, 'info');
            log('userid-log', `  Session user: ${currentSessionUser ? JSON.stringify(currentSessionUser) : 'None'}`, 'info');
            log('userid-log', `  Local user: ${currentLocalUser ? JSON.stringify(currentLocalUser) : 'None'}`, 'info');
            log('userid-log', `  Resolved user ID: ${currentUserId}`, 'info');

            if (passedTests === scenarios.length) {
                diagnosticResults.userIdDetection = true;
            }

            updateSummary();
        }

        async function simulateDashboardLoad() {
            log('simulation-log', 'Simulating complete dashboard loading process...', 'info');

            try {
                // Step 1: User ID detection (same as dashboard)
                let sessionUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
                if (!sessionUser) {
                    sessionUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                }
                const userId = sessionUser ? sessionUser.userID || sessionUser.id : 1;

                log('simulation-log', `Step 1: User ID resolved to: ${userId}`, 'info');

                // Step 2: Auth token setup
                if (!sessionStorage.getItem('authToken') && !localStorage.getItem('authToken')) {
                    sessionStorage.setItem('authToken', 'default-token');
                    log('simulation-log', 'Step 2: Set default auth token', 'info');
                } else {
                    log('simulation-log', 'Step 2: Auth token already exists', 'info');
                }

                // Step 3: Database fetch
                log('simulation-log', `Step 3: Fetching from ${API_BASE}/saved-properties/user/${userId}`, 'info');

                const response = await fetch(`${API_BASE}/saved-properties/user/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('authToken') || localStorage.getItem('authToken') || 'default-token'}`,
                        'Content-Type': 'application/json'
                    }
                });

                log('simulation-log', `Step 3: Response status: ${response.status}`, 'info');

                if (response.ok) {
                    const dbProperties = await response.json();
                    log('simulation-log', `Step 3: ‚úÖ Retrieved ${dbProperties.length} properties from database`, 'success');

                    if (dbProperties.length > 0) {
                        // Step 4: Data conversion
                        log('simulation-log', 'Step 4: Converting database format to display format...', 'info');

                        let convertedCount = 0;
                        let errorCount = 0;

                        for (const dbProp of dbProperties) {
                            try {
                                const propertyData = dbProp.propertyData ? JSON.parse(dbProp.propertyData) : {};
                                convertedCount++;
                                log('simulation-log', `  ‚úÖ Converted property ${dbProp.savedPropertyID}: ${dbProp.propertyAddress}`, 'info');
                            } catch (parseError) {
                                errorCount++;
                                log('simulation-log', `  ‚ö†Ô∏è Failed to parse property ${dbProp.savedPropertyID}: ${parseError.message}`, 'warning');
                            }
                        }

                        log('simulation-log', `Step 4: Converted ${convertedCount} properties, ${errorCount} errors`, convertedCount > 0 ? 'success' : 'warning');

                        if (convertedCount > 0) {
                            diagnosticResults.dashboardSimulation = true;
                            log('simulation-log', '‚úÖ Dashboard simulation successful - Properties should display!', 'success');
                        } else {
                            log('simulation-log', '‚ùå Dashboard simulation failed - No properties could be converted', 'error');
                        }
                    } else {
                        log('simulation-log', '‚ö†Ô∏è Database connection successful but no properties found', 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    log('simulation-log', `‚ùå Step 3: Database fetch failed: ${response.status} - ${errorText}`, 'error');
                }

                // Step 5: LocalStorage check
                const localProperties = JSON.parse(localStorage.getItem('savedProperties') || '[]');
                log('simulation-log', `Step 5: Found ${localProperties.length} properties in localStorage`, 'info');

            } catch (error) {
                log('simulation-log', `‚ùå Simulation failed: ${error.message}`, 'error');
            }

            updateSummary();
        }

        // Initialize
        updateSummary();
    </script>
</body>
</html>
